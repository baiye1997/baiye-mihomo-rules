name: Publish Gist Personal

on:
  push:
    paths:
      - "rules/ip/**"
      - "rules/non_ip/**"
      - "rules/domainset/**"
      - "rules/yaml/**"
      - "icons/**"
      - "config/baiye-*.yaml"
      - "config/baiye-*.yml"
  workflow_dispatch: {}

concurrency:
  group: build-and-publish
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide if should build
        id: decide
        shell: bash
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          if [ -z "${BEFORE}" ]; then BEFORE="$(git rev-parse HEAD^ || echo '')"; fi
          if [ -n "${BEFORE}" ]; then
            git diff --name-only "${BEFORE}" "${{ github.sha }}" > changed.all.txt
          else
            git show --name-only --pretty="" "${{ github.sha }}" > changed.all.txt
          fi

          # config 改动检测
          grep -E '^config/baiye-(single|multiple)\.ya?ml$' changed.all.txt | sort -u > changed.config.txt || true
          CONFIG_CHANGED=false; [ -s changed.config.txt ] && CONFIG_CHANGED=true

          # icons/rules 改动检测
          grep -E '^(icons/|rules/(ip|non_ip|domainset|yaml)/)' changed.all.txt | sort -u > changed.targets.txt || true

          PROCEED=false
          if [ "$CONFIG_CHANGED" = "true" ]; then
            PROCEED=true
          else
            shopt -s nullglob
            CONFIGS=(config/baiye-*.yml config/baiye-*.yaml)
            if [ -s changed.targets.txt ] && [ ${#CONFIGS[@]} -gt 0 ]; then
              : > referenced.targets.txt
              while read -r P; do
                [ -n "$P" ] || continue
                if grep -RqlF -- "$P" "${CONFIGS[@]}"; then
                  echo "$P" >> referenced.targets.txt
                fi
              done < changed.targets.txt
              if [ -s referenced.targets.txt ]; then PROCEED=true; fi
            fi
          fi

          echo "proceed=$PROCEED" >> "$GITHUB_OUTPUT"
          echo "commit_short=$(git rev-parse --short=7 ${{ github.sha }})" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        if: steps.decide.outputs.proceed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build & Publish Gist (multiple)
        if: steps.decide.outputs.proceed == 'true'
        env:
          SUB_URL_1: ${{ secrets.SUB_URL_1 }}
          SUB_URL_2: ${{ secrets.SUB_URL_2 }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID_MULTIPLE }}
          GIST_FILE_NAME: baiye-multiple.yaml
          CONFIG_PATH: config/baiye-multiple.yaml
          COMMIT_SHORT: ${{ steps.decide.outputs.commit_short }}
        run: |
          node .github/scripts/build-and-publish.js

      - name: Build & Publish Gist (single)
        if: steps.decide.outputs.proceed == 'true'
        env:
          SUB_URL_1: ${{ secrets.SUB_URL_1 }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID_SINGLE }}
          GIST_FILE_NAME: baiye-single.yaml
          CONFIG_PATH: config/baiye-single.yaml
          COMMIT_SHORT: ${{ steps.decide.outputs.commit_short }}
        run: |
          node .github/scripts/build-and-publish-single.js
