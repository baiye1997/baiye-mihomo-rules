name: Purge CDN

on:
  push:
    branches: ['**']
    tags-ignore: ['**']
    paths:
      - "rules/ip/**"
      - "rules/non_ip/**"
      - "rules/domainset/**"
      - "rules/yaml/**"
      - "icons/**"
      - "config/*.yaml"
      - "config/*.yml"
  workflow_dispatch: {}

concurrency:
  group: release-and-purge
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  release_purge:
    if: ${{ github.event_name != 'push' || startsWith(github.ref, 'refs/heads/') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ startsWith(github.ref, 'refs/tags/') && 'main' || github.ref }}

      - name: Detect changed files & map to referenced targets (safe)
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          # tag 直接早退
          if [ "${{ github.ref_type }}" = "tag" ] || [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            echo "has_ref=false" >> "$GITHUB_OUTPUT"
            echo "Skip on tag ref: ${GITHUB_REF}"
            exit 0
          fi

          BEFORE="${{ github.event.before }}"
          if [ -z "${BEFORE}" ]; then
            BEFORE="$(git rev-parse HEAD^ 2>/dev/null || echo '')"
          fi

          if [ -n "${BEFORE}" ]; then
            git diff --name-only "${BEFORE}" "${{ github.sha }}" | sort -u > changed.all.txt
          else
            : > changed.all.txt
          fi

          if [ ! -s changed.all.txt ]; then
            echo "has_ref=false" >> "$GITHUB_OUTPUT"
            echo "No file changes; skip."
            exit 0
          fi

          grep -E '^(icons/|rules/(ip|non_ip|domainset|yaml)/)' changed.all.txt | sort -u > changed.targets.txt || true

          if [ ! -s changed.targets.txt ]; then
            echo "has_ref=false" >> "$GITHUB_OUTPUT"
            echo "No icons/rules changed."
            exit 0
          fi

          shopt -s nullglob
          CONFIGS=(config/*.yml config/*.yaml)
          : > referenced.targets.txt
          if [ ${#CONFIGS[@]} -eq 0 ]; then
            echo "has_ref=false" >> "$GITHUB_OUTPUT"
            echo "No config YAML files exist; skip."
            exit 0
          fi

          while read -r P; do
            [ -n "$P" ] || continue
            if grep -RqlF -- "$P" "${CONFIGS[@]}"; then
              echo "$P" >> referenced.targets.txt
            fi
          done < changed.targets.txt

          if [ ! -s referenced.targets.txt ]; then
            echo "has_ref=false" >> "$GITHUB_OUTPUT"
            echo "Changed icons/rules are NOT referenced in config; skip."
            exit 0
          fi

          echo "has_ref=true" >> "$GITHUB_OUTPUT"
          echo "Referenced targets:"
          cat referenced.targets.txt

      - name: Purge jsDelivr for referenced targets (@latest + @main)
        if: steps.detect.outputs.has_ref == 'true'
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          : > purged.ok.txt
          : > purged.fail.txt
          while read -r p; do
            [ -n "$p" ] || continue
            for REF in latest main; do
              URL="https://purge.jsdelivr.net/gh/${REPO}@${REF}/${p}"
              # 记录 HTTP 状态码；200 视为成功
              code="$(curl -sS -o /dev/null -w '%{http_code}' "$URL" || echo 000)"
              if [ "$code" = "200" ]; then
                echo "$URL" >> purged.ok.txt
                echo "✅ $URL"
              else
                echo "$code $URL" >> purged.fail.txt
                echo "⚠️  ($code) $URL"
              fi
            done
          done < referenced.targets.txt

      - name: Summary (what got purged)
        if: always()
        shell: bash
        run: |
          echo "## Purge result" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.detect.outputs.has_ref }}" != "true" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- Skipped: no referenced targets changed." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          ok=0; fail=0
          [ -s purged.ok.txt ]   && ok=$(wc -l < purged.ok.txt)
          [ -s purged.fail.txt ] && fail=$(wc -l < purged.fail.txt)

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- OK: **$ok**"   >> "$GITHUB_STEP_SUMMARY"
          echo "- Fail: **$fail**" >> "$GITHUB_STEP_SUMMARY"

          if [ "$ok" -gt 0 ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Purged URLs" >> "$GITHUB_STEP_SUMMARY"
            sed 's/^/- /' purged.ok.txt >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ "$fail" -gt 0 ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Failed URLs (with status)" >> "$GITHUB_STEP_SUMMARY"
            sed 's/^/- /' purged.fail.txt >> "$GITHUB_STEP_SUMMARY"
          fi
