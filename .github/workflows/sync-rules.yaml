name: Sync External Rules

on:
  schedule:
    - cron: "0 22 * * *"     # UTC 22:00（东八区 06:00）
  workflow_dispatch: {}

concurrency:
  group: sync-external-rules
  cancel-in-progress: true

permissions:
  contents: read   # 拉取用；推送用 PAT

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 优化：只拉取最新代码
          persist-credentials: false

      - name: Update rule files
        run: bash scripts/update_rules.sh

      - name: Detect changes
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          if git status --porcelain | grep .; then
            echo "changed=true" >>"$GITHUB_OUTPUT"
          else
            echo "changed=false" >>"$GITHUB_OUTPUT"
          fi

      - name: Commit & Push (PAT)
        if: steps.diff.outputs.changed == 'true'
        env:
          GH_PAT: ${{ secrets.ACTIONS_PAT }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "baiye-bot"
          git config user.email "baiye-bot@users.noreply.github.com"
          
          git add -A
          git commit -m "chore(sync): update external rules from upstream"
          
          # 优化：更安全的 Push 方式
          git config --global url."https://x-access-token:${GH_PAT}@github.com/".insteadOf "https://github.com/"
          git push origin HEAD:${{ github.ref_name }}

      - name: Summary
        if: always()
        shell: bash
        run: |
          echo "## Sync result" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.diff.outputs.changed }}" = "true" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Changed files:**" >> "$GITHUB_STEP_SUMMARY"
            # 因为 fetch-depth=1，且刚 commit 了一次，所以 HEAD~1 是有效的
            git diff --name-only HEAD~1 HEAD | sed 's/^/- /' >> "$GITHUB_STEP_SUMMARY" || echo "Check commits for details"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No changes." >> "$GITHUB_STEP_SUMMARY"
          fi
