name: Sync External Rules

on:
  schedule:
    - cron: "0 22 * * *"   # UTC 22:00（东八区次日 06:00）
  workflow_dispatch: {}

concurrency:
  group: sync-external-rules
  cancel-in-progress: true

permissions:
  contents: read   

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no GITHUB_TOKEN creds)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false   

      - name: Update rule files
        run: bash scripts/update_rules.sh

      - name: Detect changes
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          if git status --porcelain | grep .; then
            echo "changed=true" >>"$GITHUB_OUTPUT"
            git diff --name-only > changed.txt
          else
            echo "changed=false" >>"$GITHUB_OUTPUT"
            : > changed.txt
          fi

      - name: Commit & Push (PAT)
        if: steps.diff.outputs.changed == 'true'
        env:
          GH_PAT: ${{ secrets.ACTIONS_PAT }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "baiye-bot"
          git config user.email "baiye-bot@users.noreply.github.com"

          git add -A
          git commit -m "chore(sync): update external rules from upstream"
          git push "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}

      - name: Summary (changed rules)
        if: always()
        shell: bash
        run: |
          echo "## Sync External Rules" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.diff.outputs.changed }}" != "true" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- No changes detected." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Updated files" >> "$GITHUB_STEP_SUMMARY"
            sed 's/^/- /' changed.txt >> "$GITHUB_STEP_SUMMARY"
          fi
