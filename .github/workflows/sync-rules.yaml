name: Sync External Rules

on:
  schedule:
    - cron: "0 22 * * *"   # UTC 22:00（东八区次日 06:00）
  workflow_dispatch: {}

concurrency:
  group: sync-external-rules
  cancel-in-progress: true

permissions:
  contents: read   # 读取够了；写入用 PAT

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no GITHUB_TOKEN creds)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false   # 关键：不用 GITHUB_TOKEN

      - name: Update rule files
        run: bash scripts/update_rules.sh

      - name: Detect changes
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          if git status --porcelain | grep .; then
            echo "changed=true" >>"$GITHUB_OUTPUT"
          else
            echo "changed=false" >>"$GITHUB_OUTPUT"
          fi

      - name: Commit & Push (PAT)
        if: steps.diff.outputs.changed == 'true'
        env:
          GH_PAT: ${{ secrets.ACTIONS_PAT }}   # 你在 Secrets 里保存的 PAT
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "baiye-bot"
          git config user.email "baiye-bot@users.noreply.github.com"

          git add -A
          # ⚠️ 不要写 [ci skip]，否则 push 不会触发其它工作流
          git commit -m "chore(sync): update external rules from upstream"

          # 推送到当前工作流的分支（通常是默认分支）
          git push "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
